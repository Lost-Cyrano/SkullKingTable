<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skull King</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        body {
            background: #0d1b2a;
            color: white;
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            width: 100%;
            max-width: 100vw;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #1b263b;
        }
        
        h1 {
            font-size: 2rem;
            color: #48cae4;
            margin-bottom: 5px;
        }
        
        .step {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .step.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .input-container {
            margin-bottom: 15px;
        }
        
        .input-field {
            width: 100%;
            padding: 12px;
            font-size: 1.1rem;
            background: #1b263b;
            border: 2px solid #415a77;
            color: white;
            border-radius: 6px;
            text-align: center;
            transition: all 0.2s;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #48cae4;
        }
        
        .player-indicator {
            background: #1b3a4b;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
            border-left: 4px solid #48cae4;
        }
        
        .history-container {
            background: #1b263b;
            border-radius: 8px;
            padding: 10px;
            max-height: 70vh;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        .history-table {
            display: table;
            width: 100%;
            min-width: 1200px;
        }
        
        .history-row {
            display: table-row;
        }
        
        .history-cell {
            display: table-cell;
            padding: 8px 4px;
            vertical-align: middle;
            border-bottom: 1px solid #2a3c5a;
            min-width: 140px;
        }
        
        .round-cell {
            width: 80px;
            min-width: 80px;
            text-align: center;
            background: #0d1b2a;
            position: sticky;
            left: 0;
            z-index: 1;
        }
        
        .player-cell {
            text-align: center;
            padding: 8px 2px;
        }
        
        .round-number {
            color: #48cae4;
            font-weight: bold;
            font-size: 0.95rem;
        }
        
        .player-total {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 2px;
        }
        
        .round-details {
            font-size: 0.75rem;
            color: #778da9;
        }
        
        .round-gain {
            font-weight: 600;
            font-size: 0.8rem;
        }
        
        .positive {
            color: #4cc9f0;
        }
        
        .negative {
            color: #f72585;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
            transition: all 0.2s;
            min-width: 150px;
        }
        
        .btn-primary {
            background: #1a759f;
            color: white;
        }
        
        .btn-primary:hover {
            background: #168aad;
        }
        
        .btn-danger {
            background: #9d0208;
            color: white;
        }
        
        .btn-danger:hover {
            background: #d00000;
        }
        
        .players-list {
            display: flex;
            flex-wrap: nowrap;
            gap: 6px;
            justify-content: center;
            margin: 10px 0;
            overflow-x: auto;
            padding: 5px 0;
        }
        
        .player-tag {
            background: #415a77;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .player-tag.current {
            background: #4cc9f0;
            transform: scale(1.05);
        }
        
        /* Pour les petits écrans, on garde le scroll horizontal */
        @media (max-width: 1200px) {
            .history-container {
                overflow-x: auto;
            }
            
            .history-table {
                min-width: 1000px;
            }
            
            .history-cell {
                min-width: 120px;
            }
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            button {
                width: 100%;
                max-width: 300px;
            }
            
            .players-list {
                justify-content: flex-start;
            }
            
            .player-tag {
                font-size: 0.75rem;
                padding: 3px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Skull King</h1>
        </header>
        
        <div id="step1" class="step active">
            <div class="input-container">
                <textarea id="playersInput" class="input-field" rows="6" placeholder="Un joueur par ligne (max 8)" autofocus>Josh
Géraldine
Anael
Esteban
Qori
Imene
Françoise</textarea>
            </div>
            <div class="controls">
                <button id="startGame" class="btn-primary">Commencer</button>
            </div>
        </div>
        
        <div id="step2" class="step">
            <div class="player-indicator">
                Manche <span id="currentRoundDisplay">1</span> • 
                <span id="currentPlayerName">Josh</span>
            </div>
            
            <div id="inputFields"></div>
            
            <div class="players-list" id="playersListDisplay"></div>
        </div>
        
        <div id="step3" class="step">
            <div class="history-container" id="historyContainer">
                <div class="history-table" id="historyTable"></div>
            </div>
            <div class="controls">
                <button id="newRound" class="btn-primary">Manche suivante</button>
                <button id="newGame" class="btn-danger">Nouvelle partie</button>
            </div>
        </div>
    </div>

    <script>
        // État du jeu
        let gameState = {
            currentRound: 1,
            players: [],
            history: [],
            currentPlayerIndex: 0,
            currentInputIndex: 0,
            inputs: ['contracts', 'results', 'bonusTens']
        };

        // Formule EXACTE
        function calculateRoundScore(round, contracts, results, bonusTens) {
            const B = Number(round) || 0;
            const C = Number(contracts) || 0;
            const D = Number(results) || 0;
            const E = Number(bonusTens) || 0;
            
            return (Math.floor(1-(Math.abs(C)/(C+1))))*((Math.floor(1-(Math.abs(D)/(D+1))))*(B*10) + (1-(Math.floor(1-(Math.abs(D)/(D+1)))))*(B*-10)) + (Math.ceil((C/(1+C))))*((1- (Math.ceil((Math.abs(C-D))/(Math.abs(C-D) + 1))))*(20*C))+(Math.ceil((C/(1+C))))*((Math.ceil((Math.abs(C-D))/(Math.abs(C-D) + 1)))*(Math.abs(C-D)*-10)) + E*10;
        }

        // Initialisation des joueurs
        function initializePlayers() {
            const textarea = document.getElementById('playersInput');
            const lines = textarea.value.split('\n')
                .map(line => line.trim())
                .filter(line => line !== '');
            
            if (lines.length === 0) {
                alert("Entrez au moins un joueur");
                return false;
            }
            
            if (lines.length > 8) {
                alert("Maximum 8 joueurs");
                return false;
            }
            
            gameState.players = lines.map((name, index) => ({
                id: index + 1,
                name: name,
                totalScore: 0,
                contracts: 0,
                results: 0,
                bonusTens: 0,
                roundScore: 0,
                runningTotal: 0
            }));
            
            gameState.currentPlayerIndex = 0;
            gameState.currentInputIndex = 0;
            
            return true;
        }

        // Sauvegarder/Charger
        function saveGameState() {
            localStorage.setItem('skullKingWide', JSON.stringify(gameState));
        }

        function loadGameState() {
            const saved = localStorage.getItem('skullKingWide');
            if (saved) {
                try {
                    gameState = JSON.parse(saved);
                    return true;
                } catch (e) {
                    console.error(e);
                }
            }
            return false;
        }

        // Navigation entre étapes
        function showStep(stepId) {
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });
            document.getElementById(stepId).classList.add('active');
        }

        // Afficher liste des joueurs
        function renderPlayersList() {
            const container = document.getElementById('playersListDisplay');
            container.innerHTML = '';
            
            gameState.players.forEach((player, index) => {
                const tag = document.createElement('span');
                tag.className = `player-tag ${index === gameState.currentPlayerIndex ? 'current' : ''}`;
                tag.textContent = player.name;
                container.appendChild(tag);
            });
        }

        // Afficher champ de saisie
        function renderInputFields() {
            const container = document.getElementById('inputFields');
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            const currentInputType = gameState.inputs[gameState.currentInputIndex];
            
            let placeholder = '';
            switch(currentInputType) {
                case 'contracts':
                    placeholder = `Contrats annoncés (max: ${gameState.currentRound})`;
                    break;
                case 'results':
                    placeholder = `Résultats obtenus (max: ${gameState.currentRound})`;
                    break;
                case 'bonusTens':
                    placeholder = `Dizaines de points bonus`;
                    break;
            }
            
            container.innerHTML = `
                <input type="number" 
                       id="currentInput" 
                       class="input-field"
                       placeholder="${placeholder}"
                       min="0" 
                       max="${currentInputType === 'bonusTens' ? '' : gameState.currentRound}"
                       autofocus>
            `;
            
            document.getElementById('currentRoundDisplay').textContent = gameState.currentRound;
            document.getElementById('currentPlayerName').textContent = currentPlayer.name;
            renderPlayersList();
            
            const input = document.getElementById('currentInput');
            input.addEventListener('keydown', handleInputEnter);
            input.focus();
        }

        // Gestion Entrée
        function handleInputEnter(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const value = parseInt(document.getElementById('currentInput').value) || 0;
                const currentPlayer = gameState.players[gameState.currentPlayerIndex];
                const currentInputType = gameState.inputs[gameState.currentInputIndex];
                
                currentPlayer[currentInputType] = value;
                
                gameState.currentInputIndex++;
                
                if (gameState.currentInputIndex >= gameState.inputs.length) {
                    gameState.currentInputIndex = 0;
                    gameState.currentPlayerIndex++;
                    
                    if (gameState.currentPlayerIndex >= gameState.players.length) {
                        calculateRound();
                        return;
                    }
                }
                
                renderInputFields();
            }
        }

        // Calculer manche
        function calculateRound() {
            // Calculer scores et running totals
            gameState.players.forEach(player => {
                player.roundScore = calculateRoundScore(
                    gameState.currentRound,
                    player.contracts,
                    player.results,
                    player.bonusTens
                );
                
                // Mettre à jour le running total (total jusqu'à cette manche)
                player.runningTotal = player.totalScore;
                player.totalScore += player.roundScore;
            });
            
            // Ajouter à l'historique
            const roundData = {
                round: gameState.currentRound,
                players: gameState.players.map(p => ({
                    name: p.name,
                    contracts: p.contracts,
                    results: p.results,
                    bonusTens: p.bonusTens,
                    roundScore: p.roundScore,
                    runningTotal: p.runningTotal
                }))
            };
            
            gameState.history.push(roundData);
            
            // Réinitialiser pour manche suivante
            gameState.players.forEach(player => {
                player.contracts = 0;
                player.results = 0;
                player.bonusTens = 0;
            });
            
            gameState.currentRound++;
            gameState.currentPlayerIndex = 0;
            gameState.currentInputIndex = 0;
            
            saveGameState();
            showResults();
        }

        // Afficher résultats
        function showResults() {
            renderHistory();
            showStep('step3');
        }

        // Afficher historique optimisé pour 8 joueurs
        function renderHistory() {
            const container = document.getElementById('historyTable');
            
            if (gameState.history.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 30px; color: #778da9;">Aucune manche enregistrée</div>';
                return;
            }
            
            let html = '<div class="history-row">';
            
            // En-tête avec la colonne Manche
            html += '<div class="history-cell round-cell">Manche</div>';
            
            // En-tête des joueurs
            gameState.players.forEach(player => {
                html += `<div class="history-cell player-cell" style="background: #1b3a4b; font-weight: bold; border-bottom: 2px solid #48cae4;">
                           ${player.name}
                         </div>`;
            });
            
            html += '</div>';
            
            // Données des manches
            gameState.history.forEach((roundData, index) => {
                html += '<div class="history-row">';
                
                // Numéro de manche
                html += `<div class="history-cell round-cell">
                           <div class="round-number">${roundData.round}</div>
                         </div>`;
                
                // Données des joueurs
                gameState.players.forEach(player => {
                    const playerData = roundData.players.find(p => p.name === player.name);
                    if (playerData) {
                        const totalAfterRound = playerData.runningTotal + playerData.roundScore;
                        
                        html += `<div class="history-cell player-cell">
                                    <div class="player-total">${totalAfterRound}</div>
                                    <div class="round-details">
                                        <span class="round-gain ${playerData.roundScore >= 0 ? 'positive' : 'negative'}">
                                            ${playerData.roundScore >= 0 ? '+' : ''}${playerData.roundScore}
                                        </span>
                                        <div>C${playerData.contracts} R${playerData.results} B${playerData.bonusTens}</div>
                                    </div>
                                 </div>`;
                    } else {
                        html += '<div class="history-cell player-cell">-</div>';
                    }
                });
                
                html += '</div>';
            });
            
            container.innerHTML = html;
            
            // Scroll vers le bas
            const historyContainer = document.getElementById('historyContainer');
            historyContainer.scrollTop = historyContainer.scrollHeight;
        }

        // Nouvelle manche
        function startNewRound() {
            renderInputFields();
            showStep('step2');
        }

        // Nouvelle partie
        function startNewGame() {
            gameState = {
                currentRound: 1,
                players: [],
                history: [],
                currentPlayerIndex: 0,
                currentInputIndex: 0,
                inputs: ['contracts', 'results', 'bonusTens']
            };
            
            localStorage.removeItem('skullKingWide');
            showStep('step1');
            document.getElementById('playersInput').focus();
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            const hasSavedGame = loadGameState();
            
            if (hasSavedGame && gameState.players.length > 0) {
                showStep('step3');
                renderHistory();
            } else {
                showStep('step1');
                document.getElementById('playersInput').focus();
            }
            
            // Événements
            document.getElementById('startGame').addEventListener('click', () => {
                if (initializePlayers()) {
                    renderInputFields();
                    showStep('step2');
                }
            });
            
            document.getElementById('newRound').addEventListener('click', () => {
                startNewRound();
            });
            
            document.getElementById('newGame').addEventListener('click', () => {
                if (confirm("Nouvelle partie ?")) {
                    startNewGame();
                }
            });
            
            // Entrée pour démarrer
            document.getElementById('playersInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && e.ctrlKey) {
                    e.preventDefault();
                    document.getElementById('startGame').click();
                }
            });
        });
    </script>
</body>
</html>
