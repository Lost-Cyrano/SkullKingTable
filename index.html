<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skull King</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        body {
            background: #0f1419;
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 100%;
            margin: 0;
            padding: 0;
        }
        
        header {
            background: #1a1f2e;
            padding: 15px 20px;
            border-bottom: 1px solid #2a3244;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        h1 {
            font-size: 1.8rem;
            color: #4dabf7;
            text-align: center;
        }
        
        .step {
            display: none;
            min-height: 100vh;
        }
        
        .step.active {
            display: block;
        }
        
        .step1-content {
            max-width: 600px;
            margin: 40px auto;
            padding: 0 20px;
        }
        
        .step2-content {
            max-width: 600px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        .input-container {
            margin-bottom: 25px;
        }
        
        .input-field {
            width: 100%;
            padding: 16px;
            font-size: 1.1rem;
            background: #1e2536;
            border: 2px solid #2a3244;
            color: white;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #4dabf7;
            background: #252d41;
        }
        
        textarea.input-field {
            min-height: 150px;
            resize: vertical;
        }
        
        .player-indicator {
            background: linear-gradient(135deg, #4dabf7, #339af0);
            color: white;
            padding: 14px;
            border-radius: 8px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        
        .players-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin: 20px 0;
        }
        
        .player-tag {
            background: #2a3244;
            color: #adb5bd;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .player-tag.current {
            background: #20c997;
            color: white;
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(32, 201, 151, 0.3);
        }
        
        .history-container {
            background: #0f1419;
            min-height: calc(100vh - 70px);
            padding: 15px;
            overflow-y: auto;
        }
        
        .history-grid {
            display: grid;
            grid-template-columns: 80px repeat(8, 1fr);
            gap: 1px;
            background: #2a3244;
            border-radius: 8px;
            overflow: hidden;
            min-width: min-content;
        }
        
        .history-header {
            background: #1a1f2e;
            padding: 12px 8px;
            font-weight: 600;
            font-size: 0.9rem;
            text-align: center;
            position: sticky;
            top: 70px;
            z-index: 10;
        }
        
        .round-header {
            background: #1a1f2e;
        }
        
        .history-cell {
            background: #1e2536;
            padding: 10px 6px;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        
        .round-cell {
            background: #252d41;
            font-weight: bold;
            color: #4dabf7;
            font-size: 1.1rem;
        }
        
        .player-total {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .round-gain {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .round-details {
            font-size: 0.75rem;
            color: #868e96;
            line-height: 1.2;
        }
        
        .positive {
            color: #20c997;
        }
        
        .negative {
            color: #ff6b6b;
        }
        
        .controls {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 30px;
            padding: 20px;
            background: #1a1f2e;
            position: sticky;
            bottom: 0;
            z-index: 100;
            border-top: 1px solid #2a3244;
        }
        
        button {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            transition: all 0.2s;
            min-width: 160px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4dabf7, #339af0);
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #339af0, #228be6);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b, #fa5252);
            color: white;
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #fa5252, #e03131);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .no-history {
            text-align: center;
            padding: 60px 20px;
            color: #868e96;
            font-size: 1.1rem;
        }
        
        @media (max-width: 1400px) {
            .history-grid {
                grid-template-columns: 70px repeat(8, minmax(140px, 1fr));
            }
            
            .history-cell {
                padding: 8px 4px;
                min-height: 70px;
            }
            
            .player-total {
                font-size: 1.1rem;
            }
        }
        
        @media (max-width: 1200px) {
            .history-grid {
                grid-template-columns: 60px repeat(8, minmax(120px, 1fr));
            }
            
            .history-header {
                font-size: 0.8rem;
                padding: 10px 4px;
            }
            
            .round-cell {
                font-size: 1rem;
            }
        }
        
        @media (max-width: 992px) {
            .history-grid {
                grid-template-columns: 50px repeat(8, minmax(100px, 1fr));
            }
            
            .history-cell {
                padding: 6px 3px;
                min-height: 65px;
            }
            
            .player-total {
                font-size: 1rem;
            }
            
            .round-gain {
                font-size: 0.8rem;
            }
            
            .round-details {
                font-size: 0.7rem;
            }
            
            button {
                min-width: 140px;
                padding: 12px 20px;
            }
        }
        
        @media (max-width: 768px) {
            .history-container {
                padding: 10px;
                overflow-x: auto;
            }
            
            .history-grid {
                min-width: 1200px;
            }
            
            .controls {
                flex-direction: column;
                padding: 15px;
            }
            
            button {
                width: 100%;
            }
            
            .step1-content,
            .step2-content {
                margin: 20px auto;
            }
        }
        
        @media (max-width: 480px) {
            header {
                padding: 12px 15px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .player-indicator {
                padding: 12px;
                font-size: 1rem;
            }
            
            .input-field {
                padding: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Skull King</h1>
        </header>
        
        <div id="step1" class="step active">
            <div class="step1-content">
                <div class="input-container">
                    <textarea id="playersInput" class="input-field" placeholder="Un joueur par ligne" autofocus>Josh
Géraldine
Anael
Esteban
Qori
Imene
Françoise</textarea>
                </div>
                <div class="controls">
                    <button id="startGame" class="btn-primary">Commencer</button>
                </div>
            </div>
        </div>
        
        <div id="step2" class="step">
            <div class="step2-content">
                <div class="player-indicator">
                    Manche <span id="currentRoundDisplay">1</span> • 
                    <span id="currentPlayerName">Josh</span>
                </div>
                
                <div id="inputFields"></div>
                
                <div class="players-list" id="playersListDisplay"></div>
            </div>
        </div>
        
        <div id="step3" class="step">
            <div class="history-container" id="historyContainer">
                <!-- L'historique sera généré ici -->
            </div>
            <div class="controls">
                <button id="newRound" class="btn-primary">Manche suivante</button>
                <button id="newGame" class="btn-danger">Nouvelle partie</button>
            </div>
        </div>
    </div>

    <script>
        // État du jeu
        let gameState = {
            currentRound: 1,
            players: [],
            history: [],
            currentPlayerIndex: 0,
            currentInputIndex: 0,
            inputs: ['contracts', 'results', 'bonusTens']
        };

        // Formule EXACTE
        function calculateRoundScore(round, contracts, results, bonusTens) {
            const B = Number(round) || 0;
            const C = Number(contracts) || 0;
            const D = Number(results) || 0;
            const E = Number(bonusTens) || 0;
            
            return (Math.floor(1-(Math.abs(C)/(C+1))))*((Math.floor(1-(Math.abs(D)/(D+1))))*(B*10) + (1-(Math.floor(1-(Math.abs(D)/(D+1)))))*(B*-10)) + (Math.ceil((C/(1+C))))*((1- (Math.ceil((Math.abs(C-D))/(Math.abs(C-D) + 1))))*(20*C))+(Math.ceil((C/(1+C))))*((Math.ceil((Math.abs(C-D))/(Math.abs(C-D) + 1)))*(Math.abs(C-D)*-10)) + E*10;
        }

        // Initialisation des joueurs
        function initializePlayers() {
            const textarea = document.getElementById('playersInput');
            const lines = textarea.value.split('\n')
                .map(line => line.trim())
                .filter(line => line !== '');
            
            if (lines.length === 0) {
                alert("Ajoutez au moins un joueur");
                return false;
            }
            
            if (lines.length > 8) {
                alert("Maximum 8 joueurs autorisés");
                return false;
            }
            
            gameState.players = lines.map((name, index) => ({
                id: index + 1,
                name: name,
                totalScore: 0,
                contracts: 0,
                results: 0,
                bonusTens: 0,
                roundScore: 0,
                runningTotal: 0
            }));
            
            gameState.currentPlayerIndex = 0;
            gameState.currentInputIndex = 0;
            
            return true;
        }

        // Sauvegarder/Charger
        function saveGameState() {
            localStorage.setItem('skullKingFullWidth', JSON.stringify(gameState));
        }

        function loadGameState() {
            const saved = localStorage.getItem('skullKingFullWidth');
            if (saved) {
                try {
                    gameState = JSON.parse(saved);
                    return true;
                } catch (e) {
                    console.error(e);
                }
            }
            return false;
        }

        // Navigation entre étapes
        function showStep(stepId) {
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });
            document.getElementById(stepId).classList.add('active');
            
            // Scroll en haut quand on change d'étape
            window.scrollTo(0, 0);
        }

        // Afficher liste des joueurs
        function renderPlayersList() {
            const container = document.getElementById('playersListDisplay');
            container.innerHTML = '';
            
            gameState.players.forEach((player, index) => {
                const tag = document.createElement('span');
                tag.className = `player-tag ${index === gameState.currentPlayerIndex ? 'current' : ''}`;
                tag.textContent = player.name;
                container.appendChild(tag);
            });
        }

        // Afficher champ de saisie
        function renderInputFields() {
            const container = document.getElementById('inputFields');
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            const currentInputType = gameState.inputs[gameState.currentInputIndex];
            
            let placeholder = '';
            switch(currentInputType) {
                case 'contracts':
                    placeholder = `Contrats pour ${currentPlayer.name} (max: ${gameState.currentRound})`;
                    break;
                case 'results':
                    placeholder = `Réussites pour ${currentPlayer.name} (max: ${gameState.currentRound})`;
                    break;
                case 'bonusTens':
                    placeholder = `Bonus pour ${currentPlayer.name}`;
                    break;
            }
            
            container.innerHTML = `
                <input type="number" 
                       id="currentInput" 
                       class="input-field"
                       placeholder="${placeholder}"
                       min="0" 
                       max="${currentInputType === 'bonusTens' ? '' : gameState.currentRound}"
                       autofocus>
            `;
            
            document.getElementById('currentRoundDisplay').textContent = gameState.currentRound;
            document.getElementById('currentPlayerName').textContent = currentPlayer.name;
            renderPlayersList();
            
            const input = document.getElementById('currentInput');
            input.addEventListener('keydown', handleInputEnter);
            input.focus();
        }

        // Gestion Entrée
        function handleInputEnter(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const value = parseInt(document.getElementById('currentInput').value) || 0;
                const currentPlayer = gameState.players[gameState.currentPlayerIndex];
                const currentInputType = gameState.inputs[gameState.currentInputIndex];
                
                currentPlayer[currentInputType] = value;
                
                gameState.currentInputIndex++;
                
                if (gameState.currentInputIndex >= gameState.inputs.length) {
                    gameState.currentInputIndex = 0;
                    gameState.currentPlayerIndex++;
                    
                    if (gameState.currentPlayerIndex >= gameState.players.length) {
                        calculateRound();
                        return;
                    }
                }
                
                renderInputFields();
            }
        }

        // Calculer manche
        function calculateRound() {
            // Calculer scores
            gameState.players.forEach(player => {
                player.roundScore = calculateRoundScore(
                    gameState.currentRound,
                    player.contracts,
                    player.results,
                    player.bonusTens
                );
                
                player.runningTotal = player.totalScore;
                player.totalScore += player.roundScore;
            });
            
            // Ajouter à l'historique
            const roundData = {
                round: gameState.currentRound,
                players: gameState.players.map(p => ({
                    name: p.name,
                    contracts: p.contracts,
                    results: p.results,
                    bonusTens: p.bonusTens,
                    roundScore: p.roundScore,
                    runningTotal: p.runningTotal
                }))
            };
            
            gameState.history.push(roundData);
            
            // Réinitialiser
            gameState.players.forEach(player => {
                player.contracts = 0;
                player.results = 0;
                player.bonusTens = 0;
            });
            
            gameState.currentRound++;
            gameState.currentPlayerIndex = 0;
            gameState.currentInputIndex = 0;
            
            saveGameState();
            showResults();
        }

        // Afficher résultats
        function showResults() {
            renderHistory();
            showStep('step3');
        }

        // Afficher historique full width
        function renderHistory() {
            const container = document.getElementById('historyContainer');
            
            if (gameState.history.length === 0) {
                container.innerHTML = '<div class="no-history">Aucune manche jouée</div>';
                return;
            }
            
            let html = '<div class="history-grid">';
            
            // En-tête des colonnes
            html += '<div class="history-header round-header">Manche</div>';
            gameState.players.forEach(player => {
                html += `<div class="history-header">${player.name}</div>`;
            });
            
            // Remplir avec des cellules vides si moins de 8 joueurs
            for (let i = gameState.players.length; i < 8; i++) {
                html += '<div class="history-header"></div>';
            }
            
            // Lignes de données
            gameState.history.forEach((roundData) => {
                // Cellule de la manche
                html += `<div class="history-cell round-cell">${roundData.round}</div>`;
                
                // Données des joueurs
                gameState.players.forEach(player => {
                    const playerData = roundData.players.find(p => p.name === player.name);
                    if (playerData) {
                        const totalAfterRound = playerData.runningTotal + playerData.roundScore;
                        const gainSign = playerData.roundScore >= 0 ? '+' : '';
                        
                        html += `<div class="history-cell">
                                    <div class="player-total">${totalAfterRound}</div>
                                    <div class="round-gain ${playerData.roundScore >= 0 ? 'positive' : 'negative'}">
                                        ${gainSign}${playerData.roundScore}
                                    </div>
                                    <div class="round-details">
                                        C${playerData.contracts} R${playerData.results} B${playerData.bonusTens}
                                    </div>
                                 </div>`;
                    } else {
                        html += '<div class="history-cell">-</div>';
                    }
                });
                
                // Cellules vides pour les colonnes non utilisées
                for (let i = gameState.players.length; i < 8; i++) {
                    html += '<div class="history-cell"></div>';
                }
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            // Scroll en bas pour voir la dernière manche
            container.scrollTop = container.scrollHeight;
        }

        // Nouvelle manche
        function startNewRound() {
            renderInputFields();
            showStep('step2');
        }

        // Nouvelle partie
        function startNewGame() {
            if (confirm("Recommencer une nouvelle partie ?")) {
                gameState = {
                    currentRound: 1,
                    players: [],
                    history: [],
                    currentPlayerIndex: 0,
                    currentInputIndex: 0,
                    inputs: ['contracts', 'results', 'bonusTens']
                };
                
                localStorage.removeItem('skullKingFullWidth');
                showStep('step1');
                document.getElementById('playersInput').focus();
            }
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            const hasSavedGame = loadGameState();
            
            if (hasSavedGame && gameState.players.length > 0) {
                showStep('step3');
                renderHistory();
            } else {
                showStep('step1');
                document.getElementById('playersInput').focus();
            }
            
            // Événements
            document.getElementById('startGame').addEventListener('click', () => {
                if (initializePlayers()) {
                    renderInputFields();
                    showStep('step2');
                }
            });
            
            document.getElementById('newRound').addEventListener('click', startNewRound);
            document.getElementById('newGame').addEventListener('click', startNewGame);
            
            // Raccourcis clavier
            document.getElementById('playersInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && e.ctrlKey) {
                    e.preventDefault();
                    document.getElementById('startGame').click();
                }
            });
            
            // Navigation clavier dans l'historique
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && document.getElementById('step3').classList.contains('active')) {
                    startNewRound();
                }
            });
        });
    </script>
</body>
</html>
